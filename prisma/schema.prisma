generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrgRole {
  OWNER
  EDITOR
  VIEWER
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]
  projects Project[]
  dataSources DataSource[]
  memberships Membership[]
  invites Invite[]
  
  brokerConnections BrokerConnection[]
  brokerSchemas BrokerSchema[]
  brokerActionLogs BrokerActionLog[]
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  orgId        String?
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: Restrict)
  memberships Membership[]

  accounts Account[]
  sessions Session[]
  brokerConnections BrokerConnection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Project {
  id        String   @id @default(cuid())
  name      String
  orgId     String
  dataSourceId String?
  spec      Json
  compiled_intent Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  dataSource DataSource? @relation(fields: [dataSourceId], references: [id], onDelete: SetNull)
  versions ToolVersion[]

  @@index([orgId])
  @@index([dataSourceId])
}

model ToolVersion {
  id            String   @id @default(cuid())
  toolId        String
  mini_app_spec Json
  status        String
  createdAt     DateTime @default(now())
  
  project       Project  @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@index([toolId])
}

model DataSource {
  id        String   @id @default(cuid())
  orgId     String
  type      String
  name      String
  config    Json
  createdAt DateTime @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  projects Project[]

  @@index([orgId])
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  orgId     String
  role      OrgRole
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([userId, orgId])
  @@index([orgId])
  @@index([userId])
}

model Invite {
  id        String   @id @default(cuid())
  orgId     String
  email     String
  role      OrgRole
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  acceptedAt DateTime?
  acceptedByUserId String?

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([email])
}

model OAuthResumeContext {
  id                  String   @id @default(uuid())
  userId              String
  orgId               String
  projectId           String?  @map("project_id")
  chatId              String?  @map("chat_id")
  toolId              String?  @map("tool_id")
  executionId         String?  @map("execution_id")
  originalPrompt      String?  @map("original_prompt")
  pendingIntegrations String[] @map("pending_integrations")
  blockedIntegration  String?  @map("blocked_integration")
  orchestrationState  Json?    @map("orchestration_state")
  returnPath          String   @map("return_path")
  expiresAt           DateTime @default(dbgenerated("now() + interval '1 hour'")) @map("expires_at")
  createdAt           DateTime @default(now()) @map("created_at")

  @@map("oauth_resume_contexts")
}

model BrokerConnection {
  id                String   @id @default(cuid())
  orgId             String   @map("org_id")
  userId            String   @map("user_id")
  integrationId     String   @map("integration_id")
  // Nango removed. Native Token Storage (Encrypted)
  accessToken       String   @map("access_token") // Encrypted
  refreshToken      String?  @map("refresh_token") // Encrypted
  expiresAt         DateTime? @map("expires_at")
  tokenType         String?  @map("token_type")
  
  status            String   
  scopes            Json
  metadata          Json?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  organization      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  actionLogs        BrokerActionLog[]

  @@unique([orgId, integrationId, userId])
  @@map("broker_connections")
}

model BrokerSchema {
  id               String   @id @default(cuid())
  orgId            String   @map("org_id")
  integrationId    String   @map("integration_id")
  resourceType     String   @map("resource_type")
  schemaDefinition Json     @map("schema_definition")
  discoveredAt     DateTime @default(now()) @map("discovered_at")
  version          Int      @default(1)

  organization     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, integrationId])
  @@map("broker_schemas")
}

model BrokerCapability {
  id                 String   @id @default(cuid())
  integrationId      String   @map("integration_id")
  capabilityId       String   @map("capability_id")
  displayName        String   @map("display_name")
  description        String?
  actionType         String   @default("READ") @map("action_type")
  composioActionName String?  @map("composio_action_name")
  resource           String?
  requiredScopes     String[] @map("required_scopes")
  inputSchema        Json     @map("input_schema")
  outputSchema       Json     @map("output_schema")
  discoveredAt       DateTime @default(now()) @map("discovered_at")
  ttlHours           Int      @default(24) @map("ttl_hours")

  @@unique([integrationId, capabilityId])
  @@index([integrationId])
  @@map("broker_capabilities")
}

model WebhookEndpoint {
  id              String    @id @default(uuid())
  orgId           String    @map("org_id")
  toolId          String    @map("tool_id")
  triggerId       String    @map("trigger_id")
  secret          String
  enabled         Boolean   @default(true)
  lastInvokedAt   DateTime? @map("last_invoked_at")
  invocationCount Int       @default(0) @map("invocation_count")
  createdAt       DateTime  @default(now()) @map("created_at")

  @@unique([toolId, triggerId])
  @@index([orgId])
  @@map("webhook_endpoints")
}

model BrokerActionLog {
  id            String   @id @default(cuid())
  orgId         String   @map("org_id")
  userId        String   @map("user_id")
  connectionId  String   @map("connection_id")
  actionId      String   @map("action_id")
  inputParams   Json?    @map("input_params")
  outputSummary Json?    @map("output_summary")
  status        String
  durationMs    Int      @map("duration_ms")
  createdAt     DateTime @default(now()) @map("created_at")

  organization  Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  connection    BrokerConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("broker_action_logs")
}
